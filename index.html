<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta property="og:title" content="Free Toddler Learning Game ü¶ÅüÖ∞Ô∏èüëÆ">
    <meta property="og:description" content="A free, ad-free educational game: Shadows, Letters, Jobs, Numbers, and Math. Play directly in your browser!">
    <meta property="og:image" content="https://ahmedashraf093.github.io/toddler-game/social-preview.png">
    <meta property="og:url" content="https://ahmedashraf093.github.io/toddler-game/">
    <meta property="og:type" content="website">
<link rel="icon" type="image/png" href="./favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="./favicon.svg" />
<link rel="shortcut icon" href="./favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png" />
<link rel="manifest" href="./site.webmanifest" />
    
  <meta name="theme-color" content="#ffffff">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="twitter:card" content="summary_large_image">
    <style>
        :root {
            --primary-color: #4facfe;
            --bg-color: #e6f7ff;
            --dot-color: #d0efff;
        }

        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Comic Neue', sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(var(--dot-color) 20%, transparent 20%),
                              radial-gradient(var(--dot-color) 20%, transparent 20%);
            background-position: 0 0, 25px 25px;
            background-size: 50px 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            user-select: none;
            touch-action: none;
            overflow-x: hidden;
            transition: background-color 0.5s ease;
        }

        /* --- Header --- */
        .header-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 95%;
            max-width: 800px;
            margin-top: 5px;
            gap: 5px;
        }

        .score-board {
            background: #fff;
            padding: 5px 20px;
            border-radius: 50px;
            font-size: 20px;
            font-weight: 900;
            color: #ffaa00;
            border: 3px solid #eee;
            box-shadow: 0 4px 0px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-bar {
            display: flex;
            gap: 5px;
            z-index: 10;
            background: rgba(255,255,255,0.6);
            padding: 5px;
            border-radius: 30px;
            backdrop-filter: blur(5px);
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-btn {
            padding: 8px 12px;
            font-size: 15px;
            border: 2px solid transparent;
            border-radius: 20px;
            background: transparent;
            cursor: pointer;
            font-weight: bold;
            color: #555;
            transition: all 0.2s;
            font-family: inherit;
        }
        .nav-btn.active {
            background: #fff;
            color: var(--primary-color);
            border-color: var(--primary-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transform: scale(1.05);
        }

        /* --- Difficulty Controls (Math Only) --- */
        #difficulty-bar {
            display: none; /* Hidden by default */
            gap: 10px;
            margin-top: 5px;
        }
        .diff-btn {
            padding: 5px 15px;
            border-radius: 15px;
            border: none;
            font-weight: bold;
            color: white;
            opacity: 0.6;
            transform: scale(0.9);
            transition: all 0.2s;
            cursor: pointer;
        }
        .diff-btn.active { opacity: 1; transform: scale(1.1); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .diff-easy { background-color: #44cc44; }
        .diff-med  { background-color: #ffaa00; }
        .diff-hard { background-color: #ff4444; }

        /* --- Standard Game Board --- */
        .game-board {
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            width: 100%;
            max-width: 900px;
            flex-grow: 1;
            padding-bottom: 80px;
        }
        .game-board.hidden { display: none; }

        .column {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 45%;
            align-items: center;
            justify-content: center;
        }

        .item {
            width: 160px;
            height: 110px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 55px;
            border-radius: 20px;
            background: white;
            border: 4px solid #fff; 
            box-shadow: 0 8px 0px rgba(0,0,0,0.1); 
            font-weight: bold;
            color: #444;
            position: relative;
            transition: transform 0.1s;
        }

        /* --- Math Step-by-Step Board --- */
        #math-stage {
            display: none; 
            flex-direction: column;
            align-items: center;
            width: 95%;
            max-width: 600px;
            flex-grow: 1;
            justify-content: center;
            gap: 20px;
        }
        #math-stage.active { display: flex; }

        .math-question-box {
            background: white;
            border-radius: 30px;
            padding: 15px;
            width: 100%;
            min-height: 180px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 10px 0 rgba(0,0,0,0.05);
            border: 5px solid white;
        }

        .math-equation {
            display: flex; align-items: center; flex-wrap: wrap; gap: 8px; flex-grow: 1; justify-content: center;
        }
        .emoji-group {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 2px; max-width: 130px;
        }

        .math-emoji { font-size: 32px; line-height: 1.1; }
        .math-operator { font-size: 45px; color: #84fab0; font-weight: 900; margin: 0 8px; }
        .math-equals { font-size: 45px; color: #ccc; margin: 0 8px; }

        .math-target {
            width: 90px; height: 90px;
            border: 4px dashed #ccc; border-radius: 20px; background: #f9f9f9;
            display: flex; justify-content: center; align-items: center;
            font-size: 45px; color: #ddd; flex-shrink: 0; transition: all 0.3s;
        }
        .math-target.hint-active { border-color: #ffd700; background-color: #ffffe0; transform: scale(1.05); }
        .math-target.matched { border-color: #44cc44; background-color: #aaffaa; color: #000; border-style: solid; }

        .math-options {
            display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;
        }
        .math-option { width: 90px; height: 90px; font-size: 45px; cursor: grab; }

        /* --- General Draggable --- */
        .draggable { cursor: grab; border-color: white; }
        .draggable:active { transform: scale(1.1) rotate(5deg); z-index: 100; cursor: grabbing; box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
        .droppable { background-color: rgba(255,255,255,0.5); border: 4px dashed #bbb; box-shadow: none; overflow: hidden; }

        /* --- Visibility Modes --- */
        .shadow-mode .droppable .content { filter: brightness(0); opacity: 0.5; pointer-events: none; }
        .letter-mode .droppable .content { opacity: 0.6; pointer-events: none; }
        .job-mode .droppable .content,
        .number-mode .droppable .content { opacity: 0.95; filter: grayscale(100%); pointer-events: none; }

        /* --- Custom Grids --- */
        .number-grid {
            display: grid; grid-template-columns: repeat(3, 1fr);
            width: 100%; height: 100%; padding: 4px; box-sizing: border-box;
            align-items: center; justify-items: center;
        }
        .mini-emoji { font-size: 30px; line-height: 1; }

        /* --- Hint & Match --- */
        .hint-active { border-color: #ffd700 !important; background-color: #ffffe0 !important; animation: hintPulse 1s infinite; z-index: 50; }
        @keyframes hintPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }
        .matched {
            background-color: #aaffaa !important; border: 4px solid #44cc44 !important;
            box-shadow: 0 0 0 5px rgba(170, 255, 170, 0.5); animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .matched .content { filter: none !important; opacity: 1 !important; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.2) rotate(-5deg); } }

        /* --- Footer --- */
        #controls { position: fixed; bottom: 20px; width: 100%; text-align: center; pointer-events: none; }
        #reset-btn {
            pointer-events: auto; padding: 12px 30px; font-size: 24px; background: #ff6b6b; color: white;
            border: 3px solid #ff4444; border-radius: 50px; cursor: pointer; display: none; font-weight: 900;
            font-family: inherit; box-shadow: 0 6px 0 #cc3333;
        }
        #reset-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #cc3333; }

        /* --- Modal --- */
        #reward-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px);
            display: flex; justify-content: center; align-items: center; z-index: 2000; visibility: hidden; opacity: 0; transition: opacity 0.3s;
        }
        #reward-modal.show { visibility: visible; opacity: 1; }
        .modal-card {
            background: white; padding: 30px; border-radius: 30px; text-align: center; border: 5px solid var(--primary-color);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3); min-width: 220px; transform: scale(0.5); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #reward-modal.show .modal-card { transform: scale(1); }
        .big-letter { font-size: 70px; display: block; line-height: 1; color: var(--primary-color); margin-bottom: 5px; }
        .big-emoji { font-size: 90px; display: block; margin: 5px 0; }
        .big-word { font-size: 35px; color: #444; font-weight: 900; display: block; }

        @media (max-width: 600px) {
            .nav-btn { padding: 6px 8px; font-size: 12px; }
            .score-board { font-size: 16px; padding: 4px 12px; }
            .column { gap: 8px; width: 48%; } 
            .item { width: 100%; height: 90px; font-size: 45px; border-width: 3px; }
            .math-question-box { flex-direction: column; gap: 15px; padding: 15px; }
            .math-target { width: 80px; height: 80px; font-size: 40px; }
        }

        /* By default, hide the container */
.install-hidden {
    display: none !important;
}

/* Style for the container when it shows */
#install-container {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999; /* Ensure it's on top of everything */
    width: 90%;
    max-width: 400px;
}

/* Style for the button itself */
#btnInstall {
    width: 100%;
    padding: 15px;
    background-color: #4CAF50; /* Nice green color */
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 18px;
    font-weight: bold;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    cursor: pointer;
    transition: background-color 0.3s;
}

#btnInstall:active {
    background-color: #3e8e41;
    transform: translateY(2px);
}


        
    </style>
</head>
<body>
<div id="install-container" class="install-hidden">
    <button id="btnInstall">üì≤ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÑÿπÿ®ÿ© (Download App)</button>
</div>
    
    <div class="header-container">
        <div class="score-board">‚≠êÔ∏è <span id="score-val">0</span></div>
        <div class="nav-bar">
            <button class="nav-btn active" onclick="setMode('shadow', this)">üê∂ Shadows</button>
            <button class="nav-btn" onclick="setMode('letter', this)">üÖ∞Ô∏è Letters</button>
            <button class="nav-btn" onclick="setMode('job', this)">üëÆ Jobs</button>
            <button class="nav-btn" onclick="setMode('number', this)">1Ô∏è‚É£ Numbers</button>
            <button class="nav-btn" onclick="setMode('math', this)">‚ûï Math</button>
        </div>
        
        <div id="difficulty-bar">
            <button class="diff-btn diff-easy active" onclick="setDifficulty('easy', this)">Easy</button>
            <button class="diff-btn diff-med" onclick="setDifficulty('medium', this)">Med</button>
            <button class="diff-btn diff-hard" onclick="setDifficulty('hard', this)">Hard</button>
        </div>
    </div>

    <div class="game-board shadow-mode" id="game-board">
        <div class="column" id="source-col"></div>
        <div class="column" id="target-col"></div>
    </div>

    <div id="math-stage">
        <div class="math-question-box">
            <div class="math-equation" id="math-eq-container"></div>
            <div class="math-equals">=</div>
            <div class="math-target droppable" id="math-target-zone" data-match="">?</div>
        </div>
        <div class="math-options" id="math-options-row"></div>
    </div>

    <div id="reward-modal">
        <div class="modal-card">
            <span class="big-letter" id="modal-top"></span>
            <span class="big-emoji" id="modal-emoji"></span>
            <span class="big-word" id="modal-word"></span>
        </div>
    </div>

    <div id="controls">
        <button id="reset-btn" onclick="initRound()">Next Round ‚û°Ô∏è</button>
    </div>

    <script>
        // --- Configuration & Data ---
        const themes = {
            shadow: { primary: '#4facfe', bg: '#e6f7ff', dots: '#d0efff' }, 
            letter: { primary: '#ff9a9e', bg: '#fff0f0', dots: '#ffe0e0' }, 
            job:    { primary: '#f6d365', bg: '#fffbe6', dots: '#fff0b3' }, 
            number: { primary: '#c084fc', bg: '#f3e8ff', dots: '#e9d5ff' },
            math:   { primary: '#84fab0', bg: '#f0fff4', dots: '#d1fae5' }
        };

        const shadowLibrary = [
            'üê∂','üê±','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêß','üêò','ü¶í','ü¶ì','ü¶ã',
            'üöó','üöå','üöë','üöí','üöì','üöú','üöÇ','‚úàÔ∏è','üöÄ','üöÅ',
            'üçé','üçå','üçá','üçì','üç¶','üç™','üçï','‚öΩ','üß∏','üéà','üñçÔ∏è'
        ];

        const letterExamples = {
            'A': { w: 'Apple', e: 'üçé' }, 'B': { w: 'Ball', e: '‚öΩ' }, 'C': { w: 'Cat', e: 'üê±' },
            'D': { w: 'Dog', e: 'üê∂' }, 'E': { w: 'Elephant', e: 'üêò' }, 'F': { w: 'Fish', e: 'üêü' },
            'G': { w: 'Grapes', e: 'üçá' }, 'H': { w: 'House', e: 'üè†' }, 'I': { w: 'Ice Cream', e: 'üç¶' },
            'J': { w: 'Juice', e: 'üßÉ' }, 'K': { w: 'Kite', e: 'ü™Å' }, 'L': { w: 'Lion', e: 'ü¶Å' },
            'M': { w: 'Monkey', e: 'üêµ' }, 'N': { w: 'Nose', e: 'üëÉ' }, 'O': { w: 'Orange', e: 'üçä' },
            'P': { w: 'Pizza', e: 'üçï' }, 'Q': { w: 'Queen', e: 'üë∏' }, 'R': { w: 'Rocket', e: 'üöÄ' },
            'S': { w: 'Sun', e: '‚òÄÔ∏è' }, 'T': { w: 'Tree', e: 'üå≤' }, 'U': { w: 'Umbrella', e: '‚òÇÔ∏è' },
            'V': { w: 'Violin', e: 'üéª' }, 'W': { w: 'Water', e: 'üíß' }, 'X': { w: 'Xylophone', e: 'üéº' },
            'Y': { w: 'Yellow', e: 'üíõ' }, 'Z': { w: 'Zebra', e: 'ü¶ì' }
        };

        const jobLibrary = [
            { id: 'police', person: 'üëÆ', tool: 'üöì', name: 'Police', toolName: 'Police Car' },
            { id: 'fire', person: 'üë®‚Äçüöí', tool: 'üöí', name: 'Fireman', toolName: 'Fire Truck' },
            { id: 'doctor', person: 'üë®‚Äç‚öïÔ∏è', tool: 'üöë', name: 'Doctor', toolName: 'Ambulance' },
            { id: 'astronaut', person: 'üë®‚ÄçüöÄ', tool: 'üöÄ', name: 'Astronaut', toolName: 'Rocket' },
            { id: 'chef', person: 'üë®‚Äçüç≥', tool: 'üç≥', name: 'Chef', toolName: 'Pan' },
            { id: 'farmer', person: 'üë®‚Äçüåæ', tool: 'üöú', name: 'Farmer', toolName: 'Tractor' },
            { id: 'artist', person: 'üë®‚Äçüé®', tool: 'üé®', name: 'Artist', toolName: 'Paint' },
            { id: 'mechanic', person: 'üë®‚Äçüîß', tool: 'üîß', name: 'Mechanic', toolName: 'Wrench' },
            { id: 'teacher', person: 'üë©‚Äçüè´', tool: 'üìö', name: 'Teacher', toolName: 'Books' },
            { id: 'pilot', person: 'üë®‚Äç‚úàÔ∏è', tool: '‚úàÔ∏è', name: 'Pilot', toolName: 'Airplane' },
            { id: 'builder', person: 'üë∑', tool: 'üî®', name: 'Builder', toolName: 'Hammer' },
            { id: 'scientist', person: 'üë®‚Äçüî¨', tool: 'üî¨', name: 'Scientist', toolName: 'Microscope' }
        ];

        // Separation of Object and Quantity
        const objectPool = [
            { e: '‚òÄÔ∏è', n: 'Suns' }, { e: 'üëü', n: 'Shoes' }, { e: 'üçé', n: 'Apples' }, 
            { e: 'üöó', n: 'Cars' }, { e: '‚≠êÔ∏è', n: 'Stars' }, { e: 'ü¶ã', n: 'Butterflies' }, 
            { e: 'üêû', n: 'Ladybugs' }, { e: 'üç™', n: 'Cookies' }, { e: 'üéà', n: 'Balloons' },
            { e: '‚öΩ', n: 'Balls' }, { e: 'üê∂', n: 'Dogs' }, { e: 'üç¶', n: 'Ice Cream' }
        ];

        // --- State ---
        let currentMode = 'shadow'; 
        let mathDifficulty = 'easy'; // easy, medium, hard
        let correctCount = 0;
        let totalScore = 0;
        const roundSize = 5;
        let hintTimer = null;
        
        let mathQuestions = []; 
        let currentMathIndex = 0;

        const history = { shadow: [], letter: [], job: [], number: [] };

        // --- Core Functions ---
        
        function setDifficulty(level, btn) {
            mathDifficulty = level;
            document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            // Restart math game with new difficulty if already in math mode
            if(currentMode === 'math') initRound();
        }

        function setMode(mode, btnEl) {
            currentMode = mode;
            
            // Buttons
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(btnEl) btnEl.classList.add('active');
            
            // UI Toggles
            const diffBar = document.getElementById('difficulty-bar');
            const standardBoard = document.getElementById('game-board');
            const mathStage = document.getElementById('math-stage');

            if (mode === 'math') {
                standardBoard.classList.add('hidden');
                mathStage.classList.add('active');
                diffBar.style.display = 'flex';
            } else {
                mathStage.classList.remove('active');
                standardBoard.classList.remove('hidden');
                standardBoard.className = 'game-board ' + mode + '-mode';
                diffBar.style.display = 'none';
            }

            // Theme
            const theme = themes[mode];
            const root = document.documentElement;
            root.style.setProperty('--primary-color', theme.primary);
            root.style.setProperty('--bg-color', theme.bg);
            root.style.setProperty('--dot-color', theme.dots);

            initRound();
        }

        function smartSelect(fullArray, modeKey) {
            const lastItems = history[modeKey];
            let available = fullArray.filter(item => {
                const id = (typeof item === 'string') ? item : (item.id || Object.keys(item)[0]); 
                return !lastItems.includes(id);
            });
            if (available.length < roundSize) available = [...fullArray];
            available.sort(() => Math.random() - 0.5);
            const selected = available.slice(0, roundSize);
            history[modeKey] = selected.map(item => (typeof item === 'string' ? item : item.id));
            return selected;
        }
        
        function shuffle(array) { return array.sort(() => Math.random() - 0.5); }

        function initRound() {
            document.getElementById('reset-btn').style.display = 'none';
            correctCount = 0;

            if (currentMode === 'math') {
                initMathGame();
            } else {
                initStandardGame();
            }
        }

        function initStandardGame() {
            const sourceCol = document.getElementById('source-col');
            const targetCol = document.getElementById('target-col');
            sourceCol.innerHTML = ''; targetCol.innerHTML = '';
            
            let roundItems = [];

            if (currentMode === 'shadow') {
                const selected = smartSelect([...shadowLibrary], 'shadow');
                roundItems = selected.map(i => ({id: i, src: i, tgt: i, type: 'simple'}));
            } 
            else if (currentMode === 'letter') {
                const allKeys = Object.keys(letterExamples);
                const selectedKeys = smartSelect(allKeys, 'letter');
                roundItems = selectedKeys.map(k => ({ id: k, src: k, tgt: k.toLowerCase(), type: 'simple' }));
            } 
            else if (currentMode === 'job') {
                const selected = smartSelect([...jobLibrary], 'job');
                roundItems = selected.map(j => ({ id: j.id, src: j.person, tgt: j.tool, type: 'simple' }));
            }
            else if (currentMode === 'number') {
                // Generate numbers 1-9 randomly
                const nums = [1,2,3,4,5,6,7,8,9];
                const selectedNums = smartSelect(nums.map(String), 'number'); // store history as strings
                
                roundItems = selectedNums.map(nStr => {
                    const count = parseInt(nStr);
                    // Randomly select an object for this number
                    const randomObj = objectPool[Math.floor(Math.random() * objectPool.length)];
                    
                    let gridHtml = `<div class="number-grid">`;
                    for(let i=0; i<count; i++) gridHtml += `<span class="mini-emoji">${randomObj.e}</span>`;
                    gridHtml += `</div>`;
                    
                    return { 
                        id: nStr, 
                        src: gridHtml, 
                        tgt: nStr, 
                        type: 'html',
                        emoji: randomObj.e,
                        name: randomObj.n
                    };
                });
            }

            const draggables = shuffle([...roundItems]);
            const targets = shuffle([...roundItems]);

            draggables.forEach(obj => createStandardItem(obj.src, obj.id, sourceCol, true, obj.type, obj));
            targets.forEach(obj => createStandardItem(obj.tgt, obj.id, targetCol, false, obj.type, obj));
        }

        function createStandardItem(content, id, container, isDrag, type, dataObj) {
            const el = document.createElement('div');
            el.className = `item ${isDrag ? 'draggable' : 'droppable'}`;
            
            if(isDrag) {
                if (type === 'html') el.innerHTML = content;
                else el.textContent = content;
                el.draggable = true;
                el.id = 'drag-' + id + '-' + Math.random().toString(36).substr(2, 5);
                el.dataset.val = id;
                addDragEvents(el);
            } else {
                el.dataset.match = id;
                const c = document.createElement('div');
                c.className = 'content';
                if (type === 'html') c.innerHTML = content; 
                else c.textContent = content;
                el.appendChild(c);
                el.addEventListener('dragover', e => e.preventDefault());
                el.addEventListener('drop', drop);
                
                // Store data for rewards
                if(dataObj) {
                    el.dataset.emoji = dataObj.emoji;
                    el.dataset.name = dataObj.name;
                }
            }
            container.appendChild(el);
        }

        // --- MATH GAME LOGIC ---
        function initMathGame() {
            currentMathIndex = 0;
            mathQuestions = [];

            // Generate 5 questions based on difficulty
            for(let i=0; i<roundSize; i++) {
                let A, B, op, ans;

                if (mathDifficulty === 'easy') {
                    // Addition, Sum <= 5
                    ans = Math.floor(Math.random() * 4) + 2; // 2 to 5
                    A = Math.floor(Math.random() * (ans - 1)) + 1; // 1 to ans-1
                    B = ans - A;
                    op = '+';
                } 
                else if (mathDifficulty === 'medium') {
                    // Addition, Sum <= 9
                    ans = Math.floor(Math.random() * 8) + 2; // 2 to 9
                    A = Math.floor(Math.random() * (ans - 1)) + 1;
                    B = ans - A;
                    op = '+';
                } 
                else { // Hard
                    // Subtraction (Result 1-9) or Addition (Sum 1-9)
                    if (Math.random() > 0.5) {
                        // Add
                        ans = Math.floor(Math.random() * 8) + 2;
                        A = Math.floor(Math.random() * (ans - 1)) + 1;
                        B = ans - A;
                        op = '+';
                    } else {
                        // Subtract
                        ans = Math.floor(Math.random() * 9) + 1; // Result 1-9
                        // A - B = ans -> A = ans + B. Max A should probably be 9 for visuals
                        // Actually, let's keep A <= 9 so grids look nice.
                        A = Math.floor(Math.random() * (9 - ans)) + ans;
                        if (A === ans) A = ans + 1; // Ensure some subtraction occurs
                        if (A > 9) A = 9;
                        B = A - ans;
                        op = '-';
                    }
                }
                
                mathQuestions.push({ A, B, op, ans });
            }
            loadMathQuestion();
        }

        function loadMathQuestion() {
            if(currentMathIndex >= mathQuestions.length) {
                document.getElementById('reset-btn').style.display = 'inline-block';
                speakText("All done! Good job!");
                return;
            }

            const q = mathQuestions[currentMathIndex];
            const container = document.getElementById('math-eq-container');
            const target = document.getElementById('math-target-zone');
            const optionsRow = document.getElementById('math-options-row');

            // Pick random object for visuals
            const randomObj = objectPool[Math.floor(Math.random() * objectPool.length)];
            const emoji = randomObj.e;

            const buildGroup = (n) => {
                let s = '<div class="emoji-group">';
                for(let i=0; i<n; i++) s += `<span class="math-emoji">${emoji}</span>`;
                s += '</div>';
                return s;
            };

            container.innerHTML = `
                ${buildGroup(q.A)}
                <div class="math-operator">${q.op === '+' ? '‚ûï' : '‚ûñ'}</div>
                ${buildGroup(q.B)}
            `;

            target.textContent = '?';
            target.className = 'math-target droppable';
            target.dataset.match = q.ans.toString();
            // Store TTS and Emoji for reward
            const opWord = q.op === '+' ? 'plus' : 'minus';
            target.dataset.tts = `${q.A} ${opWord} ${q.B} equals ${q.ans}`;
            target.dataset.emoji = emoji;

            target.addEventListener('dragover', e => e.preventDefault());
            target.addEventListener('drop', dropMath);

            // Generate Options (Always include Answer + 2 Randoms)
            optionsRow.innerHTML = '';
            let opts = [q.ans];
            while(opts.length < 3) {
                let r = Math.floor(Math.random() * 9) + 1;
                if(!opts.includes(r)) opts.push(r);
            }
            shuffle(opts);

            opts.forEach(val => {
                const el = document.createElement('div');
                el.className = 'item math-option draggable';
                el.textContent = val;
                el.draggable = true;
                el.id = 'math-opt-' + val;
                el.dataset.val = val;
                addDragEvents(el);
                optionsRow.appendChild(el);
            });
        }

        // --- Interaction Logic ---
        function addDragEvents(el) {
            el.addEventListener('dragstart', dragStart);
            el.addEventListener('dragend', dragEnd);
            el.addEventListener('touchstart', touchStart, {passive: false});
            el.addEventListener('touchmove', touchMove, {passive: false});
            el.addEventListener('touchend', touchEnd);
        }

        let draggedVal = null, draggedElId = null, activeTouchEl = null;

        function startHintTimer(val) {
            clearHint(); 
            hintTimer = setTimeout(() => { showHint(val); }, 5000);
        }

        function showHint(val) {
            const targets = document.querySelectorAll('.droppable');
            targets.forEach(t => {
                if(currentMode === 'math') {
                    if (t.id === 'math-target-zone' && t.dataset.match === val) t.classList.add('hint-active');
                } else {
                    if(t.dataset.match === val && !t.classList.contains('matched')) t.classList.add('hint-active');
                }
            });
        }
        function clearHint() {
            if(hintTimer) clearTimeout(hintTimer);
            document.querySelectorAll('.hint-active').forEach(el => el.classList.remove('hint-active'));
        }

        function dragStart(e) { draggedVal = e.target.dataset.val; draggedElId = e.target.id; startHintTimer(draggedVal); }
        function dragEnd(e) { clearHint(); }
        function drop(e) { e.preventDefault(); clearHint(); const box = e.target.closest('.droppable'); if(box && currentMode !== 'math') checkStandardMatch(box, draggedVal, draggedElId); }
        
        function dropMath(e) {
            e.preventDefault(); clearHint();
            const box = e.target.closest('.droppable');
            if(box && box.dataset.match === draggedVal) {
                box.classList.add('matched');
                box.textContent = draggedVal;
                totalScore += 10; updateScoreUI();
                speakText("Correct! " + box.dataset.tts);
                launchModal(draggedVal, box.dataset.emoji, "Correct!");
                setTimeout(() => { currentMathIndex++; loadMathQuestion(); }, 2500);
            }
        }

        function touchStart(e) {
            e.preventDefault(); const actualItem = e.target.closest('.draggable'); if(!actualItem) return;
            activeTouchEl = actualItem; draggedVal = activeTouchEl.dataset.val; draggedElId = activeTouchEl.id;
            startHintTimer(draggedVal);
            const t = e.touches[0]; activeTouchEl.style.position = 'fixed'; activeTouchEl.style.zIndex = '1000';
            activeTouchEl.style.left = (t.clientX - 50) + 'px'; activeTouchEl.style.top = (t.clientY - 50) + 'px';
        }
        function touchMove(e) { e.preventDefault(); if(!activeTouchEl) return; const t = e.touches[0]; activeTouchEl.style.left = (t.clientX - 50) + 'px'; activeTouchEl.style.top = (t.clientY - 50) + 'px'; }
        function touchEnd(e) {
            if(!activeTouchEl) return; clearHint();
            const t = e.changedTouches[0]; activeTouchEl.style.display = 'none';
            const below = document.elementFromPoint(t.clientX, t.clientY); activeTouchEl.style.display = 'flex';
            activeTouchEl.style.position = 'static'; activeTouchEl.style.zIndex = '';
            const box = below ? below.closest('.droppable') : null;
            if(box) {
                if(currentMode === 'math') {
                    if(box.id === 'math-target-zone' && box.dataset.match === draggedVal) {
                        box.classList.add('matched'); box.textContent = draggedVal;
                        totalScore += 10; updateScoreUI();
                        speakText("Correct! " + box.dataset.tts);
                        launchModal(draggedVal, box.dataset.emoji, "Correct!");
                        setTimeout(() => { currentMathIndex++; loadMathQuestion(); }, 2500);
                    }
                } else {
                    checkStandardMatch(box, draggedVal, draggedElId);
                }
            }
            activeTouchEl = null;
        }

        function checkStandardMatch(targetBox, val, originalId) {
            if (targetBox.classList.contains('matched') || targetBox.dataset.match !== val) return;
            targetBox.classList.add('matched');
            const source = document.getElementById(originalId);
            if(source) source.style.visibility = 'hidden';
            totalScore += 10; updateScoreUI();

            if (currentMode === 'letter') showLetterReward(val);
            else if (currentMode === 'job') showJobReward(val);
            else if (currentMode === 'number') {
                // Use stored data for randomized reward
                launchModal(val, targetBox.dataset.emoji, targetBox.dataset.name);
                speakText(`${val}... ${targetBox.dataset.name}`);
            }
            else speakText("Yeah!");

            correctCount++;
            if (correctCount === roundSize) {
                document.getElementById('reset-btn').style.display = 'inline-block';
                setTimeout(() => speakText("Good Job!"), 1000);
            }
        }

        function updateScoreUI() {
            const scoreEl = document.getElementById('score-val');
            scoreEl.textContent = totalScore;
            scoreEl.parentElement.style.transform = "scale(1.2)";
            setTimeout(() => { scoreEl.parentElement.style.transform = "scale(1)"; }, 200);
        }

        function showLetterReward(letter) {
            const data = letterExamples[letter];
            launchModal(`${letter}${letter.toLowerCase()}`, data.e, data.w);
            speakText(`${letter}... ${data.w}`);
        }
        function showJobReward(jobId) {
            const jobData = jobLibrary.find(j => j.id === jobId);
            launchModal(jobData.person, jobData.tool, jobData.name);
            speakText(`${jobData.name}... uses... ${jobData.toolName}`);
        }
        function launchModal(topText, emoji, word) {
            const modal = document.getElementById('reward-modal');
            document.getElementById('modal-top').textContent = topText;
            document.getElementById('modal-emoji').textContent = emoji;
            document.getElementById('modal-word').textContent = word;
            modal.classList.add('show');
            setTimeout(() => { modal.classList.remove('show'); }, 2500);
        }
        function speakText(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.8; utterance.pitch = 1.1; 
                const voices = window.speechSynthesis.getVoices();
                const enVoice = voices.find(v => v.lang.startsWith('en'));
                if(enVoice) utterance.voice = enVoice;
                window.speechSynthesis.speak(utterance);
            }
        }
        if ('speechSynthesis' in window) window.speechSynthesis.onvoiceschanged = () => {};

        // Init
        setMode('shadow', document.querySelector('.nav-btn.active'));
    </script>
    <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
        // --- PWA INSTALL BUTTON LOGIC ---

let deferredPrompt; // To hold the event
const installContainer = document.getElementById('install-container');
const btnInstall = document.getElementById('btnInstall');

// 1. Listen for the 'beforeinstallprompt' event.
// This event is fired by Chrome/Android when the site meets PWA criteria.
window.addEventListener('beforeinstallprompt', (e) => {
  // Prevent Chrome 67 and earlier from automatically showing the prompt
  e.preventDefault();
  // Stash the event so it can be triggered later.
  deferredPrompt = e;
  // Show the install button container
  installContainer.classList.remove('install-hidden');
  console.log("Install prompt is ready to be triggered");
});

// 2. Handle the button click
btnInstall.addEventListener('click', async () => {
  if (!deferredPrompt) {
      return;
  }
  // Hide the button container immediately after click
  installContainer.classList.add('install-hidden');
  
  // Show the browser's native install prompt
  deferredPrompt.prompt();
  
  // Wait for the user to respond to the prompt
  const { outcome } = await deferredPrompt.userChoice;
  console.log(`User response to install prompt: ${outcome}`);
  
  // We've used the prompt, so clear the variable. 
  // It can only be used once.
  deferredPrompt = null;
});

// Optional: Listen for successful installation to log it
window.addEventListener('appinstalled', () => {
  installContainer.classList.add('install-hidden');
  deferredPrompt = null;
  console.log('PWA was installed successfully');
});
  </script>
</body>
</html>
